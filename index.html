<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instagram Downloader & Compressor</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 600px; margin: 40px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h1 { text-align: center; }
        #controls { display: flex; gap: 10px; margin-bottom: 20px; }
        #instaUrl { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #getVideoBtn { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #getVideoBtn:disabled { background-color: #cccccc; }
        #log { margin-top: 20px; padding: 10px; background-color: #e9ecef; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; min-height: 50px; }
        #downloadLink { display: none; text-align: center; margin-top: 20px; padding: 15px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Instagram Downloader & Compressor</h1>
    <div id="controls">
        <input type="text" id="instaUrl" placeholder="https://www.instagram.com/reel/.../">
        <button id="getVideoBtn">Get & Compress</button>
    </div>
    <div id="log">Status updates will appear here...</div>
    <a href="#" id="downloadLink">Download Compressed Video</a>

    <!-- This script tag loads the FFmpeg library -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>

    <!-- This is our main application script -->
    <script>
        // We wrap everything in this event listener.
        // The code inside will only run AFTER the entire page is loaded.
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('instaUrl');
            const getBtn = document.getElementById('getVideoBtn');
            const logEl = document.getElementById('log');
            const downloadLink = document.getElementById('downloadLink');

            let ffmpeg;

            const log = (message) => {
                logEl.textContent = message;
                console.log(message);
            };

            const base64ToUint8Array = (base64) => {
                const binary_string = window.atob(base64);
                const len = binary_string.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binary_string.charCodeAt(i);
                }
                return bytes;
            };

            const initialize = async () => {
                getBtn.disabled = true;
                log('Initializing...');

                // Correctly access the FFmpeg class from the global window object
                const { FFmpeg } = window.FFmpeg;
                ffmpeg = new FFmpeg();

                ffmpeg.on('log', ({ message }) => {
                    if (message.includes('frame=')) {
                        log(`Compressing: ${message}`);
                    }
                });

                log('Loading FFmpeg core... (this may take a moment)');
                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
                });

                log('Ready. Paste a URL and click "Get & Compress"');
                getBtn.disabled = false;
            };

            const startProcess = async () => {
                if (!urlInput.value) {
                    log('Please paste an Instagram URL first.');
                    return;
                }
                getBtn.disabled = true;
                downloadLink.style.display = 'none';

                try {
                    log('Asking our server to fetch the video...');
                    const response = await fetch('/.netlify/functions/getVideo', {
                        method: 'POST',
                        body: JSON.stringify({ instaUrl: urlInput.value })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'The server returned an error.');
                    
                    log('✅ Video data received. Decoding...');
                    const videoData = base64ToUint8Array(data.videoData);
                    
                    await ffmpeg.writeFile('input.mp4', videoData);
                    log('Starting compression... This can take a while.');
                    
                    await ffmpeg.exec(['-i', 'input.mp4', '-vcodec', 'libx264', '-crf', '28', '-ac', '1', 'output.mp4']);
                    log('✅ Compression finished!');

                    const compressedData = await ffmpeg.readFile('output.mp4');
                    const compressedUrl = URL.createObjectURL(new Blob([compressedData.buffer], { type: 'video/mp4' }));
                    
                    downloadLink.href = compressedUrl;
                    downloadLink.download = `${data.fileName || 'compressed'}.mp4`;
                    downloadLink.style.display = 'block';
                    
                } catch (error) {
                    log(`❌ Error: ${error.message}`);
                    console.error(error);
                } finally {
                    getBtn.disabled = false;
                }
            };

            getBtn.addEventListener('click', startProcess);
            initialize(); // Start the initialization process
        });
    </script>
</body>
</html>
